<!DOCTYPE html>
<html>
<head>
	<title>Test Path Generation</title>
	<link rel="stylesheet" type="text/css" href="../game.css">
</head>
<body>
	<ul>
		<li><a href='spread.html?400'>400</a></li>
		<li><a href='spread.html?500'>500</a></li>
		<li><a href='spread.html?600'>600</a></li>
		<li><a href='spread.html?700'>700</a></li>
		<li><a href='spread.html?900'>900</a></li>
		<li><a href='spread.html?1400'>1400</a></li>
		<li><a href='spread.html?1900'>1900</a></li>
		<li><a href='spread.html?2100'>2100</a></li>
	</ul>
	<div id='w' class='g'>
		<canvas id='f' width=800 height=600></canvas>
	</div>
	<script src='../js/lib/jsfxr.js'></script>
	<script src="../js/init.js"></script>
	<script src="../js/const.js"></script>

	<script src="../js/dom.js"></script>
	<script src="../js/shaders.js"></script>
  <script src="../js/drawing.js"></script>
	<script src="../js/geometry.js"></script>
	<script src="../js/math.js"></script>
	<script src="../js/rand.js"></script>
	<script src="../js/path.js"></script>
    <script type="text/javascript">
        seed = 101
        if (document.location.search.length) {
            seed = parseInt(document.location.search.substr(1), 10);
        }

		// generate a path
		var canvas = $.getElementById('f');
		r = $.getRandomNumberGenerator(seed)

    let {width, height} = canvas;

		var DEGREES_TO_RADIANS = Math.PI / 180;

		var generateProjectileSpread = (r, x, y, minWaves=1, maxWaves=5,
			minProjectilesPerWave=1, maxProjectilesPerWave=5,
			minPaths=1, maxPaths=6, maxFireTime=2000) => {
				let numAngles = $.randBetween(r, minPaths, maxPaths),
					minAngle = 10,
					maxAngle = numAngles <= 2 ? 90 : 90 / (numAngles - 1),
					angleBetween = $.randBetween(r, minAngle, maxAngle),
					numWaves = $.randBetween(r, minWaves, maxWaves),
					projectilesPerWave = $.randBetween(r, minProjectilesPerWave, maxProjectilesPerWave),
					totalProjectiles = numWaves * numAngles * projectilesPerWave,
					timeBetweenProjectiles = $.randBetween(r, 16, maxFireTime / totalProjectiles),
					midPoint = numAngles / 2 - 0.5,
					paths = [],
					offsetT = 0,
					i, j, k, offset, angle, xPerMs, yPerMs;
					for (i = 0; i < numWaves; i++) {
						for (j = 0; j < numAngles; j++) {
							let offset = j - midPoint;
							let angle =( (180 + (offset * angleBetween) + 360) % 360) * DEGREES_TO_RADIANS;
							let xPerMs = Math.cos(angle) * 200 / 1000;
							let yPerMs = Math.sin(angle) * 200 / 1000;

							for (k = 0; k < projectilesPerWave; k++) {
								paths.push([x, y, xPerMs, yPerMs, offsetT]);
								offsetT += timeBetweenProjectiles;
							}
						}
					}
					return paths;
		};

		let projectilePaths = generateProjectileSpread(r, canvas.width - 50, canvas.height / 2);
		let projectile = $.makeWebGLReady(['#ddd', 5, [5, 5]])

		var startTime = Date.now();
		setInterval(() => {
      let gl = $.get3DContext(canvas);
			let currentTime = (Date.now() - startTime);
      let prog = $.prepareCanvasForShapes(gl, width, height);

      $.clear3DCanvas(gl);
			for (var i = 0; i < projectilePaths.length; i++) {
				let path = projectilePaths[i];
				let [x, y, xPerMs, yPerMs, startTime] = path;
				if (currentTime >= startTime) {
					let elapsedTime = currentTime - startTime;

					// draw the projectile
					$.drawShapesToCanvasGL(gl, prog, [projectile], x + (elapsedTime * xPerMs), y + (elapsedTime * yPerMs))
				}
			}

		}, 16);

	</script>
</body>
</html>
